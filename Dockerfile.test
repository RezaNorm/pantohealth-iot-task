# Multi-stage build for running tests
FROM node:18-alpine AS test

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY nest-cli.json ./
COPY tsconfig*.json ./

# Install all dependencies (including dev dependencies for testing)
RUN npm ci && npm cache clean --force

# Copy source code
COPY libs/ ./libs/
COPY apps/ ./apps/
COPY test/ ./test/
COPY jest.setup.js ./

# Build the project
RUN npm run build

# Set environment variables for testing
ENV NODE_ENV=test
ENV MONGODB_URI=mongodb://test-mongo:27017/xray-iot-test
ENV RABBITMQ_URL=amqp://test-rabbitmq:5672

# Expose test results directory
VOLUME ["/app/coverage"]

# Default command to run tests
CMD ["npm", "run", "test:cov"]
